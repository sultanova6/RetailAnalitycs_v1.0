## История покупок

#### Представление История покупок

| **Поле**                        | **Название поля в системе** | **Формат / возможные значения**  | **Описание**                                                                                                                                                                                                 |
|:-------------------------------:|:---------------------------:|:--------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор клиента           | Customer_ID                 | ---                              | ---                                                                                                                                                                                                          |
| Идентификатор транзакции        | Transaction_ID              | ---                              | ---                                                                                                                                                                                                          |
| Дата транзакции                 | Transaction_DateTime        | гггг-мм-ддTчч:мм:сс.0000000      | Дата совершения транзакции                                                                                                                                                                                   |
| Группа SKU                      | Group_ID                    | ---                              | Идентификатор группы родственных товаров, к которой относится товар (например, одинаковые йогурты одного производителя и объема, но разных вкусов). Указывается один идентификатор для всех товаров в группе |
| Себестоимость                   | Group_Cost                  | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Базовая розничная стоимость     | Group_Summ                  | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Фактически оплаченная стоимость | Group_Summ_Paid             | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |

1.  **Определение транзакций клиента.** Для каждого клиента формируется
    список уникальных транзакций по всем его картам. Для этого
    используются данные, содержащиеся в поле `Transaction_ID` таблицы
    [Транзакции](../README.md#таблица-транзакции). Связка с идентификатором клиента (`Customer_ID`
    таблицы [Персональные данные](../README.md#таблица-персональные-данные)) осуществляется через
    идентификаторы всех карт клиента (поле `Customer_Card_ID` таблиц
    [Карты](../README.md#таблица-карты) и [Транзакции](../README.md#таблица-транзакции)). Результат сохраняется
    в поле `Transaction_ID` таблицы История покупок. В таблице
    сохраняются уникальные значения Идентификатор клиента
    (`Customer_ID`) – Идентификатор транзакции (`Transaction_ID`).

2.  **Определение дат совершения транзакций.** Для каждой транзакции
    указывается ее дата. Для определения даты совершения транзакции
    используются данные, содержащиеся в поле `Transaction_DateTime` таблицы
    [Транзакции](../README.md#таблица-транзакции), идентификация осуществляется по полю
    `Transaction_ID` таблиц История покупок и [Транзакции](../README.md#таблица-транзакции).
    Результат сохраняется в поле `Transaction_DateTime` таблицы История покупок.

3.  **Определение списка SKU.** Для каждой транзакции указывается список
    SKU, которые были приобретены клиентом в рамках конкретной
    транзакции. Для этого используются данные, содержащиеся в поле
    `SKU_ID` таблицы [Чеки](../README.md#таблица-чеки). Сопоставление осуществляется на
    основании данных, содержащихся в полях `Transaction_ID` таблиц История покупок и [Чеки](../README.md#таблица-чеки).

4.  **Дедубликация списка SKU.** Список SKU дедублицируется
    индивидуально для каждой транзакции. Для каждой транзакции
    формируется список уникальных SKU.

5. **Определение списка групп.** Для каждого SKU на основании данных из
   товарной матрицы указывается его группа. Для этого используются
   данные, содержащиеся в поле `Group_ID` таблицы Товарная
   матрица, сопоставление осуществляется по полю `SKU_ID` таблиц История покупок и [Товарная матрица](../README.md#таблица-товарная-матрица).

6. **Дедубликация списка групп.** Список групп дедублицируется
   индивидуально для каждой транзакции. Итоговый результат сохраняется
   в поле `Group_ID` таблицы История покупок. В таблице должны
   содержаться уникальные значения, сформированные из совокупности
   данных Идентификатор клиента (`Customer_ID`) – Идентификатор
   транзакции (`Transaction_ID`) – Идентификатор группы (`Group_ID`).
   При этом дата транзакции автоматически распространяется на все
   группы, которые были приобретены в рамках данной транзакции.

7.  **Подсчет финансовых показателей по группе.** Для каждого клиента по
    каждой группе осуществляется подсчет основных финансовых показателей
    путем суммирования аналогичных показателей для всех SKU, входящих в
    конкретную группу. Суммируются данные из таблицы [Чеки](../README.md#таблица-чеки).
    Подсчитываются следующие показатели:

    - Себестоимость купленного клиентом товара в течение 
      анализируемого периода. Суммируются значения, полученные путем умножения данных из поля `SKU_Purchase_Price` на данные из поля `SKU_Amount`
      по всем SKU анализируемой группы для клиента. Данные
      сохраняются в поле `Group_Cost` таблицы [История покупок](../README.md#представление-история-покупок).

    - Базовая розничная стоимость в течение анализируемого периода.
      Суммируются данные из поля `SKU_Summ` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ` таблицы [История покупок](../README.md#представление-история-покупок).

    - Фактически оплаченная стоимость (с учетом оплаты покупок
      бонусами программы лояльности, но без учета скидок).
      Суммируются данные их поля `SKU_Summ_Paid` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ_Paid` таблицы [История покупок](../README.md#представление-история-покупок).
